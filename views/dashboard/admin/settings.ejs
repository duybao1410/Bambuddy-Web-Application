<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings | Admin</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icon -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>

    <!-- CSS Global Variable -->
    <link rel="stylesheet" href="/css/style.css" />

    <!-- CSS Style -->
    <link rel="stylesheet" href="/css/user.css" />
    <!-- Password Validation -->
    <script src="/js/passwordValidation.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/theme-loader.js"></script>
  </head>
  <body class="<%= user?.theme || 'light' %>">
    <%- include('../../partials/navbar') %>

    <div class="container-fluid p-3 p-md-5">
      <main id="main-content" class="user-page-container row" role="main" aria-label="Admin Settings Page">
        <div class="edit-profile-container col-12 col-lg-8 mx-auto px-xl-4 px-3" role="main" aria-label="Settings form">
          <h1 id="settings-heading">Admin Settings</h1>
          <div class="container">
            <div class="row border-bottom">
              <div class="row">
                <div class="col-12 col-xl-8 ps-md-0 p-0 m-0">
                  <div class="basicInformation-container p-3 p-md-4 my-3 my-md-4">
                    <h5 class="mb-4">Basic Account Information</h5>
                    <div class="row">
                      <div class="col-12 col-md-8">
                        <label for="email" class="form-label">Email Address</label>
                        <input type="email" id="email" class="form-control" value="<%= user.email %>" disabled />
                        <small class="text-muted">Email cannot be changed after registration</small>
                      </div>
                      <div class="col-12 col-md-4">
                        <label for="accountType" class="form-label">Account Type</label>
                        <input type="text" id="accountType" class="form-control" value="admin" disabled />
                      </div>
                    </div>
                    <label for="phoneInput" class="form-label">Phone Numbers</label>
                    <input id="phoneInput" type="text" class="form-control" value="<%= settings?.phone || '' %>" />
                  </div>
                </div>

                <div class="col-12 col-xl-4 mb-3">
                  <div class="profilePhoto-container row p-3 p-xl-4 my-xl-4 ms-xl-3 d-flex justify-content-center align-items-center">
                    <h5 class="mb-4 ps-0">Appearance</h5>
                    <label class="form-label">Theme Appearance</label>
                    <div class="d-flex flex-column gap-3">
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="theme" id="light" value="light" <%= (user.theme === 'light' || !user.theme) ? 'checked' : '' %> />
                        <label for="light" class="form-check-label">Light</label>
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio" name="theme" id="dark" value="dark" <%= user.theme === 'dark' ? 'checked' : '' %> />
                        <label for="dark" class="form-check-label">Dark</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12 ps-md-0 p-0 m-0">
                  <div class="basicInformation-container p-3 p-md-4 my-3 my-md-4">
                    <h5 class="mb-4">Password</h5>
                    <form id="passwordForm" aria-labelledby="password-heading">
                      <label for="currentPassword" class="form-label">Current Password</label>
                      <div class="position-relative">
                        <input type="password" id="currentPassword" name="currentPassword" class="form-control" required />
                      </div>
                      <div class="row">
                        <div class="col-12 col-md-6">
                          <label for="newPassword" class="form-label">New Password</label>
                          <div class="position-relative">
                            <input type="password" id="newPassword" name="newPassword" class="form-control" required />
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="confirmPassword" class="form-label">Confirm New Password</label>
                          <div class="position-relative">
                            <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required />
                          </div>
                        </div>
                      </div>
                      <div class="alert bg-light border mt-3 small">
                        <strong>Password Requirements:</strong>
                        <ul class="mb-0 ps-3">
                          <li>At least 8 characters long</li>
                          <li>Mix of uppercase and lowercase letters</li>
                          <li>At least one number</li>
                          <li>At least one special character (@#$%^&*)</li>
                        </ul>
                      </div>
                      <button type="submit" class="btn-primary py-2 mt-3">Update Password</button>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <%- include('../../partials/footer') %>

    <script>
      const phoneInput = document.getElementById('phoneInput');
      phoneInput?.addEventListener('change', async () => {
        try {
          const res = await fetch('/user/settings/phone', { // reuse endpoint for phone update
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ phone: phoneInput.value })
          });
          const data = await res.json();
        } catch (e) {}
      });

      document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', async (e) => {
          try {
            const selectedTheme = e.target.value;
            const response = await fetch('/auth/settings/theme', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ theme: selectedTheme })
            });
            const data = await response.json();
            if (data.success) {
              document.body.className = selectedTheme;
              try { localStorage.setItem('userTheme', selectedTheme); } catch (err) {}
            }
          } catch (err) {}
        });
      });

      document.getElementById('passwordForm')?.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = e.target.currentPassword.value;
        const newPassword = e.target.newPassword.value;
        const confirmPassword = e.target.confirmPassword.value;
        if (newPassword !== confirmPassword) return;
        try {
          await fetch('/auth/settings/password', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ currentPassword, newPassword })
          });
        } catch (err) {}
      });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>

