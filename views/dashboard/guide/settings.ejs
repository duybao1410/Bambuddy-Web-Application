<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Settings | Guide</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icon -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <!-- Google Font -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"
    />

    <!-- CSS Global Variable -->
    <link rel="stylesheet" href="/css/style.css" />

    <!-- CSS Style For Guide/User -->
    <link rel="stylesheet" href="/css/user.css" />
    <!-- Password Validation -->
    <script src="/js/passwordValidation.js"></script>

    <!-- Axios -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script src="/js/theme-loader.js"></script>
  </head>
  <body class="<%= user?.theme || 'light' %>">
    <%- include('../../partials/navbar') %>

    <div class="container-fluid p-3 p-md-5">
      <main
        id="main-content"
        class="user-page-container row"
        role="main"
        aria-label="Guide Settings Page"
      >
        <% if (user.role !== 'admin') { %>
        <aside
          class="user-sidebar-navigation col-12 col-md-3 px-0 pe-md-3 mb-4 mb-md-0"
          role="navigation"
          aria-label="Dashboard navigation"
        >
          <ul class="nav flex-column flex-md-column row-gap-2 p-2" role="menubar">
            <% if (user.role !== 'admin') { %>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
              role="none"
            >
              <a
                class="nav-link flex-fill"
                href="/guide/dashboard"
                role="menuitem"
                aria-label="Overview"
                tabindex="0"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-kanban me-2"
                  viewBox="0 0 16 16"
                  aria-hidden="true"
                >
                  <path
                    d="M13.5 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1h-11a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1zm-11-1a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h11a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2z"
                  />
                  <path
                    d="M6.5 3a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1zm-4 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v7a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1zm8 0a1 1 0 0 1 1-1h1a1 1 0 0 1 1 1v10a1 1 0 0 1-1 1h-1a1 1 0 0 1-1-1z"
                  />
                </svg>
                <span>Overview</span>
              </a>
            </li>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
            >
              <a
                class="nav-link flex-fill"
                aria-current="page"
                href="/guide/profile"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-person-circle me-2"
                  viewBox="0 0 16 16"
                >
                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                  <path
                    fill-rule="evenodd"
                    d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"
                  />
                </svg>
                <span>My Profile</span>
              </a>
            </li>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
            >
              <a
                class="nav-link flex-fill"
                aria-current="page"
                href="/guide/booking"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-list-ul me-2"
                  viewBox="0 0 16 16"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2"
                  />
                </svg>
                <span>Booking Management</span>
              </a>
            </li>
            <% } %>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
            >
              <a
                class="nav-link active flex-fill"
                aria-current="page"
                href="/guide/settings"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-gear-wide-connected me-2"
                  viewBox="0 0 16 16"
                >
                  <path
                    d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.613.931l-.08.284a.96.96 0 0 0 1.187 1.187l.283-.081c.96-.275 1.65.918.931 1.613l-.211.205a.96.96 0 0 0 .434 1.622l.286.071c.97.243.97 1.62 0 1.864l-.286.071a.96.96 0 0 0-.434 1.622l.211.205c.719.695.03 1.888-.931 1.613l-.284-.08a.96.96 0 0 0-1.187 1.187l.081.283c.275.96-.918 1.65-1.613.931l-.205-.211a.96.96 0 0 0-1.622.434zM12.973 8.5H8.25l-2.834 3.779A4.998 4.998 0 0 0 12.973 8.5m0-1a4.998 4.998 0 0 0-7.557-3.779l2.834 3.78zM5.048 3.967l-.087.065zm-.431.355A4.98 4.98 0 0 0 3.002 8c0 1.455.622 2.765 1.615 3.678L7.375 8zm.344 7.646.087.065z"
                  />
                </svg>
                <span>Settings</span>
              </a>
            </li>
          </ul>
        </aside>
        <% } %>
        <div
          class="edit-profile-container <%= user.role === 'admin' ? 'col-12 col-lg-8 mx-auto' : 'col-md-9 col-12' %> px-xl-4 px-3"
          role="main"
          aria-label="Settings form"
        >
          <h1 id="settings-heading">Settings</h1>
          <div class="container">
            <div class="row border-bottom">
              <div class="row">
                <div class="col-12 col-md-8">
                  <div
                    class="basicInformation-container p-3 p-md-4 my-3 my-md-4"
                  >
                    <h5 id="basic-info-heading" class="mb-4">Basic Account Information</h5>
                    <div class="row">
                      <div class="col-12 col-md-8">
                        <label for="email" class="form-label"
                          >Email Address</label
                        >
                        <input
                          type="email"
                          id="email"
                          class="form-control"
                          value="<%= user?.email || '' %>"
                          disabled
                          aria-describedby="email-help"
                        />
                        <div id="email-help" class="visually-hidden">
                          Your email address (cannot be changed)
                        </div>
                        <small class="text-muted"
                          >Email cannot be changed after registration</small
                        >
                      </div>
                      <div class="col-12 col-md-4">
                        <label for="accountType" class="form-label"
                          >Account Type</label
                        >
                        <input
                          type="text"
                          id="accountType"
                          class="form-control"
                          value="<%= user?.role %>"
                          disabled
                        />
                      </div>
                    </div>
                    <label for="phoneInput" class="form-label"
                      >Phone Numbers</label
                    >
                    <input
                      id="phoneInput"
                      type="tel"
                      class="form-control"
                      value="<%= user?.profileInfo?.phone || '' %>"
                      placeholder="Enter your phone number"
                      aria-describedby="phone-help"
                    />
                    <div id="phone-help" class="visually-hidden">
                      Enter your phone number for account verification
                    </div>
                  </div>
                </div>

                <div class="col-12 col-md-4 mb-3">
                  <div
                    class="profilePhoto-container row p-3 p-xl-4 my-xl-4 ms-xl-3 d-flex justify-content-center align-items-center"
                  >
                    <h5 id="appearance-heading" class="mb-4 ps-0">Appearance</h5>
                    <fieldset>
                      <legend class="form-label">Theme Appearance</legend>
                      <div class="d-flex flex-column gap-3" role="radiogroup">
                      <div class="form-check">
                        <input class="form-check-input" type="radio"
                        name="theme" id="light" value="light" <%= (user.theme
                        === 'light' || !user.theme) ? 'checked' : '' %> aria-describedby="light-theme-help">
                        <div id="light-theme-help" class="visually-hidden">
                          Switch to light theme
                        </div>
                        <label for="light" class="form-check-label"
                          >Light</label
                        >
                      </div>
                      <div class="form-check">
                        <input class="form-check-input" type="radio"
                        name="theme" id="dark" value="dark" <%= user.theme ===
                        'dark' ? 'checked' : '' %> aria-describedby="dark-theme-help">
                        <div id="dark-theme-help" class="visually-hidden">
                          Switch to dark theme
                        </div>
                        <label for="dark" class="form-check-label">Dark</label>
                      </div>
                      </div>
                    </fieldset>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12 ps-md-0 p-0 m-0">
                  <div
                    class="basicInformation-container p-3 p-md-4 my-3 my-md-4"
                  >
                    <h5 id="password-heading" class="mb-4">Password</h5>
                    <form id="passwordForm" aria-labelledby="password-heading">
                      <label for="currentPassword" class="form-label"
                        >Current Password</label
                      >
                      <div class="position-relative">
                        <input
                          type="password"
                          id="currentPassword"
                          name="currentPassword"
                          class="form-control"
                          required
                          aria-describedby="current-password-help"
                        />
                        <div id="current-password-help" class="visually-hidden">
                          Enter your current password
                        </div>
                      </div>
                      <div class="row">
                        <div class="col-12 col-md-6">
                          <label for="newPassword" class="form-label"
                            >New Password</label
                          >
                          <div class="position-relative">
                            <input
                              type="password"
                              id="newPassword"
                              name="newPassword"
                              class="form-control"
                              required
                            />
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="confirmPassword" class="form-label"
                            >Confirm New Password</label
                          >
                          <div class="position-relative">
                            <input
                              type="password"
                              id="confirmPassword"
                              name="confirmPassword"
                              class="form-control"
                              required
                            />
                          </div>
                        </div>
                      </div>
                      <div class="alert bg-light border mt-3 small">
                        <strong>Password Requirements:</strong>
                        <ul class="mb-0 ps-3">
                          <li>At least 8 characters long</li>
                          <li>Mix of uppercase and lowercase letters</li>
                          <li>At least one number</li>
                          <li>At least one special character (@#$%^&*)</li>
                        </ul>
                      </div>
                      <button
                        type="submit"
                        class="btn-primary py-2 mt-3"
                        aria-describedby="update-password-help"
                      >
                        Update Password
                      </button>
                      <div id="update-password-help" class="visually-hidden">
                        Update your password with the new one
                      </div>
                    </form>
                  </div>
                </div>
              </div>

              <div class="row">
                <div class="col-12 ps-md-0 p-0 m-0">
                  <div
                    class="basicInformation-container p-3 p-md-4 my-3 my-md-4"
                  >
                    <h5 class="mb-4">Deactivate Account</h5>
                    <p class="small">When you deactivate your account:</p>
                    <ul class="small">
                      <li>Your profile will be hidden from search results</li>
                      <li>Existing bookings will remain active</li>
                      <li>You won't receive new booking requests</li>
                      <li>You can reactivate anytime by logging in</li>
                    </ul>
                    <label for="reasonSelect" class="form-label"
                      >Reason for deactivation (optional)</label
                    >
                    <select
                      id="reasonSelect"
                      class="form-control"
                      name="reason"
                    >
                      <option value="">Select a reason</option>
                      <option value="privacy">Privacy concerns</option>
                      <option value="not-needed">No longer needed</option>
                      <option value="other">Other</option>
                    </select>
                    <button
                      id="deactivateBtn"
                      type="button"
                      class="btn btn-danger mt-3"
                      aria-describedby="deactivate-account-help"
                    >
                      Deactivate Account
                    </button>
                    <div id="deactivate-account-help" class="visually-hidden">
                      Permanently deactivate your account
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </main>
    </div>
    <%- include('../../partials/footer') %>

    <script src="/js/user.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
    <script>
      function showNotification(message, type = "success") {
        const div = document.createElement("div");
        div.className = `toast align-items-center text-bg-${
          type === "success" ? "success" : "danger"
        } border-0 position-fixed top-0 end-0 m-3`;
        div.setAttribute("role", "alert");
        div.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.body.appendChild(div);
        const t = new bootstrap.Toast(div, { delay: 2500 });
        t.show();
        setTimeout(() => div.remove(), 3000);
      }
      // Phone update (reuses existing user endpoint)
      const phoneInput = document.getElementById("phoneInput");
      phoneInput?.addEventListener("change", async () => {
        try {
          const res = await fetch("/user/settings/phone", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ phone: phoneInput.value }),
          });
          const data = await res.json();
          if (data.success) {
            if (window.showNotification) showNotification("Phone updated");
          } else {
            if (window.showNotification)
              showNotification(data.error || "Failed", "error");
          }
        } catch (e) {
          if (window.showNotification) showNotification("Failed", "error");
        }
      });

      // Password update
      document
        .getElementById("passwordForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const currentPassword = e.target.currentPassword.value;
          const newPassword = e.target.newPassword.value;
          const confirmPassword = e.target.confirmPassword.value;
          if (typeof validatePassword === "function") {
            const pv = validatePassword(newPassword);
            if (!pv.isValid) {
              if (window.showPasswordErrors) showPasswordErrors(pv.errors);
              return;
            }
          }
          if (newPassword !== confirmPassword) {
            if (window.showNotification)
              showNotification("Passwords do not match", "error");
            return;
          }
          try {
            const res = await fetch("/auth/settings/password", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ currentPassword, newPassword }),
            });
            const data = await res.json();
            if (data.success) {
              if (window.showNotification)
                showNotification(data.message || "Password updated");
            } else {
              if (window.showNotification)
                showNotification(
                  data.message || data.error || "Failed",
                  "error"
                );
            }
          } catch (e) {
            if (window.showNotification)
              showNotification(e?.message || "Failed", "error");
          }
        });

      // Theme toggle
      document.querySelectorAll('input[name="theme"]').forEach((r) => {
        r.addEventListener("change", async function (e) {
          const selectedTheme = e.target.value;
          try {
            const response = await fetch("/auth/settings/theme", {
              method: "PUT",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ theme: selectedTheme }),
            });
            const data = await response.json();
            if (data.success) {
              document.body.className = selectedTheme;
              try {
                localStorage.setItem("userTheme", selectedTheme);
              } catch (err) {}
              if (window.showNotification)
                showNotification("Theme updated to " + selectedTheme);
            } else {
              if (window.showNotification)
                showNotification(
                  data.error || "Failed to update theme",
                  "error"
                );
            }
          } catch (error) {
            if (window.showNotification)
              showNotification("Failed to update theme", "error");
          }
        });
      });

      // Deactivate account
      document
        .getElementById("deactivateBtn")
        ?.addEventListener("click", async () => {
          try {
            const res = await fetch("/auth/settings/deactivate", {
              method: "POST",
            });
            const data = await res.json();
            if (data.success) {
              if (window.showNotification)
                showNotification("Account deactivated");
              window.location.href = "/auth/login";
            } else {
              if (window.showNotification)
                showNotification(data.error || "Failed", "error");
            }
          } catch (e) {
            if (window.showNotification) showNotification("Failed", "error");
          }
        });
    </script>
  </body>
</html>
