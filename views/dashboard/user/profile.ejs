<!-- /* User Profile */ -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile Info | Bambuddy</title>

    <!-- Bootstrap CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
      crossorigin="anonymous"
    />
    <!-- Bootstrap Icon -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css"
    />

    <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>

    <!-- CSS Global Variable -->
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/theme.css" />

    <!-- CSS Style For Guide/User -->
    <link rel="stylesheet" href="/css/user.css" />
    <script src="/js/theme-loader.js"></script>
  </head>
  <body class="<%= user?.theme || 'light' %>">
    <%- include('../../partials/navbar') %>

    <div class="container-fluid p-3 p-md-5">
      <% if (typeof error !== 'undefined' && error) { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
          aria-label="Close"
        ></button>
      </div>
      <% } %>
      <main
        id="main-content"
        class="user-page-container row"
        role="main"
        aria-label="User Profile Edit Page"
      >
        <aside
          class="user-sidebar-navigation col-12 col-md-3 px-0 pe-md-3 mb-4 mb-md-0"
          role="navigation"
          aria-label="Dashboard navigation"
        >
          <ul class="nav flex-column row-gap-2 p-2" role="menubar">
            <li
              class="nav-item d-flex justify-content-start align-items-center"
              role="none"
            >
              <a
                class="nav-link active flex-fill"
                aria-current="page"
                href="/user/profile"
                role="menuitem"
                aria-label="My Profile - Current page"
                tabindex="0"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-person-circle me-2"
                  viewBox="0 0 16 16"
                  aria-hidden="true"
                >
                  <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0" />
                  <path
                    fill-rule="evenodd"
                    d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"
                  /></svg
                ><span>My Profile</span></a
              >
            </li>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
              role="none"
            >
              <a
                class="nav-link flex-fill"
                href="/user/save-tour"
                role="menuitem"
                aria-label="Saved Tours"
                tabindex="0"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-bookmarks me-2"
                  viewBox="0 0 16 16"
                  aria-hidden="true"
                >
                  <path
                    d="M2 4a2 2 0 0 1 2-2h6a2 2 0 0 1 2 2v11.5a.5.5 0 0 1-.777.416L7 13.101l-4.223 2.815A.5.5 0 0 1 2 15.5zm2-1a1 1 0 0 0-1 1v10.566l3.723-2.482a.5.5 0 0 1 .554 0L11 14.566V4a1 1 0 0 0-1-1z"
                  />
                  <path
                    d="M4.268 1H12a1 1 0 0 1 1 1v11.768l.223.148A.5.5 0 0 0 14 13.5V2a2 2 0 0 0-2-2H6a2 2 0 0 0-1.732 1"
                  />
                </svg>
                <span>Saved Tours</span></a
              >
            </li>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
              role="none"
            >
              <a
                class="nav-link flex-fill"
                href="/user/booking"
                role="menuitem"
                aria-label="My Trips"
                tabindex="0"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-list-ul me-2"
                  viewBox="0 0 16 16"
                  aria-hidden="true"
                >
                  <path
                    fill-rule="evenodd"
                    d="M5 11.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m0-4a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5m-3 1a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2m0 4a1 1 0 1 0 0-2 1 1 0 0 0 0 2"
                  /></svg
                ><span>Booking Management</span></a
              >
            </li>
            <li
              class="nav-item d-flex justify-content-start align-items-center"
              role="none"
            >
              <a
                class="nav-link flex-fill"
                href="/user/settings"
                role="menuitem"
                aria-label="Settings"
                tabindex="0"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  fill="currentColor"
                  class="bi bi-gear-wide-connected me-2"
                  viewBox="0 0 16 16"
                  aria-hidden="true"
                >
                  <path
                    d="M7.068.727c.243-.97 1.62-.97 1.864 0l.071.286a.96.96 0 0 0 1.622.434l.205-.211c.695-.719 1.888-.03 1.613.931l-.08.284a.96.96 0 0 0 1.187 1.187l.283-.081c.96-.275 1.65.918.931 1.613l-.211.205a.96.96 0 0 0 .434 1.622l.286.071c.97.243.97 1.62 0 1.864l-.286.071a.96.96 0 0 0-.434 1.622l.211.205c.719.695.03 1.888-.931 1.613l-.284-.08a.96.96 0 0 0-1.187 1.187l.081.283c.275.96-.918 1.65-1.613.931l-.205-.211a.96.96 0 0 0-1.622.434l-.071.286c-.243.97-1.62.97-1.864 0l-.071-.286a.96.96 0 0 0-1.622-.434l-.205.211c-.695.719-1.888.03-1.613-.931l.08-.284a.96.96 0 0 0-1.186-1.187l-.284.081c-.96.275-1.65-.918-.931-1.613l.211-.205a.96.96 0 0 0-.434-1.622l-.286-.071c-.97-.243-.97-1.62 0-1.864l.286-.071a.96.96 0 0 0 .434-1.622l-.211-.205c-.719-.695-.03-1.888.931-1.613l.284.08a.96.96 0 0 0 1.187-1.186l-.081-.284c-.275-.96.918-1.65 1.613-.931l.205.211a.96.96 0 0 0 1.622-.434zM12.973 8.5H8.25l-2.834 3.779A4.998 4.998 0 0 0 12.973 8.5m0-1a4.998 4.998 0 0 0-7.557-3.779l2.834 3.78zM5.048 3.967l-.087.065zm-.431.355A4.98 4.98 0 0 0 3.002 8c0 1.455.622 2.765 1.615 3.678L7.375 8zm.344 7.646.087.065z"
                  /></svg
                ><span>Settings</span></a
              >
            </li>
          </ul>
        </aside>

        <div
          class="edit-profile-container col-md-9 col-12 px-xl-4 px-3"
          role="main"
          aria-label="Profile edit form"
        >
          <h1 id="profile-heading">Edit Profile</h1>
          <div class="container">
            <div class="row border-bottom">
              <form
                id="profileForm"
                enctype="multipart/form-data"
                aria-labelledby="profile-heading"
                novalidate
              >
                <div class="row">
                  <div class="col-12 col-xl-6 ps-md-0 p-0 m-0">
                    <div
                      class="basicInformation-container p-3 p-md-4 my-3 my-md-4"
                      role="group"
                      aria-labelledby="basic-info-heading"
                    >
                      <h5 id="basic-info-heading" class="mb-0">
                        Basic Information
                      </h5>
                      <div class="row">
                        <div class="col-12 col-md-6">
                          <label for="firstName" class="form-label"
                            >First Name</label
                          >
                          <input
                            type="text"
                            id="firstName"
                            name="firstName"
                            class="form-control"
                            value="<%= profile?.profileInfo?.firstName || '' %>"
                            placeholder="Enter your first name"
                            aria-describedby="firstName-help"
                          />
                          <div id="firstName-help" class="visually-hidden">
                            Enter your first name
                          </div>
                        </div>
                        <div class="col-12 col-md-6">
                          <label for="lastName" class="form-label"
                            >Last Name</label
                          >
                          <input
                            type="text"
                            id="lastName"
                            name="lastName"
                            value="<%= profile?.profileInfo?.lastName || '' %>"
                            class="form-control"
                            placeholder="Enter your last name"
                            aria-describedby="lastName-help"
                          />
                          <div id="lastName-help" class="visually-hidden">
                            Enter your last name
                          </div>
                        </div>
                      </div>

                      <label for="city" class="form-label">City</label>
                      <input
                        type="text"
                        id="city"
                        name="city"
                        class="form-control"
                        value="<%= profile?.profileInfo?.city || '' %>"
                        placeholder="Enter your city"
                        aria-describedby="city-help"
                      />
                      <div id="city-help" class="visually-hidden">
                        Enter the city where you live
                      </div>
                      <label for="bio" class="form-label">Bio</label>
                      <textarea
                        name="bio"
                        id="bio"
                        class="form-control"
                        rows="6"
                        placeholder="Tell others about yourself"
                        aria-describedby="bio-help"
                      >
<%= profile?.profileInfo?.bio || '' %></textarea
                      >
                      <div id="bio-help" class="visually-hidden">
                        Write a brief description about yourself
                      </div>
                      <label for="facebook" class="form-label">Facebook</label>
                      <input
                        type="url"
                        id="facebook"
                        name="facebook"
                        value="<%= profile?.profileInfo?.facebook || '' %>"
                        class="form-control"
                        placeholder="https://facebook.com/yourprofile"
                        aria-describedby="facebook-help"
                      />
                      <div id="facebook-help" class="visually-hidden">
                        Enter your Facebook profile URL (optional)
                      </div>
                      <label for="instagram" class="form-label"
                        >Instagram</label
                      >
                      <input
                        type="url"
                        id="instagram"
                        name="instagram"
                        value="<%= profile?.profileInfo?.instagram || '' %>"
                        class="form-control"
                        placeholder="https://instagram.com/yourprofile"
                        aria-describedby="instagram-help"
                      />
                      <div id="instagram-help" class="visually-hidden">
                        Enter your Instagram profile URL (optional)
                      </div>
                    </div>
                  </div>

                  <div class="col-12 col-xl-6 mb-3">
                    <div
                      class="profilePhoto-container row p-3 p-xl-4 my-xl-4 ms-xl-3 d-flex justify-content-center align-items-center"
                      role="group"
                      aria-labelledby="photo-heading"
                    >
                      <h5 id="photo-heading" class="mb-0 ps-0">Profile Photo</h5>
                      <img
                        src="<%= (user && user.profilePicture)
                          ? (user.profilePicture.startsWith('http')
                              ? user.profilePicture
                              : ('/uploads/profilePicture/' + user.profilePicture))
                          : '/img/defaultAvatar.png' %>"
                        class="profile-picture p-0 m-3"
                        alt="<%= profile?.profileInfo?.firstName || 'User' %>'s profile picture"
                        id="profilePicturePreview"
                      />
                      <input
                        type="file"
                        id="profilePhoto"
                        name="profilePhoto"
                        class="visually-hidden"
                        accept="image/png, image/jpeg"
                        aria-describedby="photo-requirements"
                      />

                      <div class="d-flex flex-column align-items-center">
                        <button
                          type="button"
                          id="changePhotoBtn"
                          class="btn btn-outline-primary"
                          aria-describedby="photo-requirements"
                        >
                          Change Photo
                        </button>
                        <small id="photo-requirements" class="m-2"
                          >Recommended: 400x400px, Max 2MB</small
                        >
                        <div
                          id="profilePhotoError"
                          class="invalid-feedback d-block"
                          style="display: none"
                        ></div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="row">
                  <button
                    type="submit"
                    class="btn-primary py-2"
                    aria-describedby="save-help"
                  >
                    Save Changes
                  </button>
                  <div id="save-help" class="visually-hidden">
                    Save all profile changes
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </main>
    </div>

    <%- include('../../partials/footer') %>

    <script src="/js/user.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q"
      crossorigin="anonymous"
    ></script>
    <script>
      function showNotification(message, type = "success") {
        const div = document.createElement("div");
        div.className = `toast align-items-center text-bg-${
          type === "success" ? "success" : "danger"
        } border-0 position-fixed top-0 end-0 m-3`;
        div.setAttribute("role", "alert");
        div.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button></div>`;
        document.body.appendChild(div);
        const t = new bootstrap.Toast(div, { delay: 2500 });
        t.show();
        setTimeout(() => div.remove(), 3000);
      }

      // Profile form submission
      document
        .getElementById("profileForm")
        ?.addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData(e.target);

          // Show loading state
          const submitBtn = e.target.querySelector('button[type="submit"]');
          const originalText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = "Updating...";

          try {
            const res = await fetch("/user/profile", {
              method: "POST",
              headers: {
                Accept: "application/json",
                "X-Requested-With": "XMLHttpRequest",
              },
              body: formData,
            });

            let data;
            const responseText = await res.text();
            console.log("Server response:", responseText);

            try {
              data = JSON.parse(responseText);
            } catch (jsonError) {
              console.error("JSON parse error:", jsonError);
              console.error("Response status:", res.status);
              console.error("Response headers:", res.headers);
              throw new Error(
                `Server returned invalid response (${
                  res.status
                }): ${responseText.substring(0, 100)}...`
              );
            }

            if (data.success) {
              showNotification(data.message || "Profile updated successfully");
              // Refresh the page to show updated avatar
              setTimeout(() => window.location.reload(), 2000);
            } else {
              showNotification(
                data.error || "Failed to update profile",
                "error"
              );
            }
          } catch (error) {
            console.error("Profile update error:", error);
            showNotification(
              "Failed to update profile: " + error.message,
              "error"
            );
          } finally {
            // Reset button state
            submitBtn.disabled = false;
            submitBtn.textContent = originalText;
          }
        });
    </script>
  </body>
</html>
