<!DOCTYPE html>
<html lang="en">
<head>
  <title>Forum - Threads</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CSS and bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/forum.css">
    <link rel="stylesheet" href="/css/style.css">
  <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>
    <script src="/js/theme-loader.js"></script>
  </head>
  <body class="<%= user?.theme || 'light' %>">

  <%- include('../partials/navbar') %>

<main class="container" role="main">
  <script>
    (function(){
      const params = new URLSearchParams(window.location.search);
      if (params.get('pending') === '1') {
        const n = document.createElement('div');
        n.className = 'notification success';
        n.textContent = 'Your thread is pending approval by an admin.';
        document.body.appendChild(n);
        setTimeout(() => n.classList.add('show'), 50);
        setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 300); }, 3000);
        params.delete('pending');
        const url = `${window.location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
        window.history.replaceState({}, '', url);
      }
    })();
  </script>
  <div class="row">
    
    <header class="header-image">
      <h1 class="header-title">Threads Forum</h1>
      <!-- Search box -->
      <form action="/threads/search" method="GET" class="search-form" role="search">
        <label for="thread-search" class="visually-hidden">Search threads</label>
        <input 
          id="thread-search"
          type="text" 
          name="q" 
          value="<%= query || '' %>" 
          placeholder="Search threads..." 
          minlength="2"
          aria-describedby="search-help"
        />
        <span id="search-help" class="visually-hidden">Enter at least 2 characters to search</span>
        
      </form>
    </header>

    <!-- Main Content - Threads -->
    <section class="col-12 col-md-9" style="min-height: 550px;" aria-labelledby="recent-threads-heading">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 id="recent-threads-heading">Recent Threads:</h2>
        <form action="/threads/search" method="GET" class="d-flex align-items-center" role="search">
          <label for="sortSelect" class="me-2 mb-0">Sort by:</label>
          <select name="Sort by:" id="sortSelect" class="form-select me-2" style="width: auto; height: 42px;" aria-describedby="sort-help">
            <option value="relevance" <%= sort === 'relevance' ? 'selected' : '' %>>Relevance</option>
            <option value="lastActivity" <%= sort === 'lastActivity' ? 'selected' : '' %>>Last Activity</option>
            <option value="createdAt" <%= sort === 'createdAt' ? 'selected' : '' %>>Created Date</option>
          </select>
          <span id="sort-help" class="visually-hidden">Choose how to sort the thread list</span>
          <button type="submit" class="btn btn-primary btn-sm" aria-label="Apply sort filter">Sort</button>
        </form>
      </div>
      
     <!-- Thread List Container -->
      <div class="list-group" role="list" aria-label="Forum threads">
        <% if (threads && threads.length > 0) { %>
          <% threads.forEach(thread => { %>
            <article class="list-group-item" role="listitem">
              <h3>
                <a style="text-decoration: none; color: var(--primary-dark);" 
                   href="/threads/<%= thread._id %>"
                   aria-describedby="thread-<%= thread._id %>-meta">
                   <%= thread.title %>
                </a>
              </h3>
              <div id="thread-<%= thread._id %>-meta">
                <p>
                  <strong>Posted by:</strong>
                  <a href="/member/<%= thread.authorId?._id %>" aria-label="View author profile" style="text-decoration: none;">
                    <span aria-label="Author">
                      <%= thread.authorId?.profileInfo?.firstName || "Guest" %>
                      <%= thread.authorId?.profileInfo?.lastName || "" %>
                    </span>
                  </a>
                </p>

                <div aria-label="Thread statistics">
                  <small>
                    Last activity: <time><%= thread.lastActivity %></time><br>
                    <span aria-label="<%= thread.likeCount %> likes">Likes: <%= thread.likeCount %></span> | 
                    <span aria-label="<%= thread.dislikeCount %> dislikes">Dislikes: <%= thread.dislikeCount %></span> | 
                    <span aria-label="<%= thread.commentCount %> comments">Comments: <%= thread.commentCount %></span>
                  </small>
                </div>
                
                <% if (thread.tags && thread.tags.length > 0) { %>
                  <div aria-label="Thread tags">
                    <p>Tags: 
                      <% thread.tags.forEach(tag => { %>
                        <span class="badge badge-custom text-decoration-none" role="button" tabindex="0">#<%= tag %></span>
                      <% }) %>
                    </p>
                  </div>
                <% } %>
              </div>
            </article>
          <% }) %>    
        <% } else { %>
          <p role="status" aria-live="polite">No threads found.</p>
        <% } %>
      </div>

      <!-- Pagination -->
      <nav class="mt-3" aria-label="Thread pagination" role="navigation">
        <ul class="pagination mx-auto justify-content-center">
          <% if (pagination.hasPrev) { %>
            <li class="page-item">
                <a class="page-link" 
                   href="/threads?page=<%= pagination.currentPage - 1 %>"
                   aria-label="Go to previous page">
                   Previous
                </a>
            </li>
          <% } %>
          <li class="page-item disabled">         
            <span class="page-link" aria-current="page">
              Page <%= pagination.currentPage %> of <%= pagination.totalPages %>
            </span>
          </li>
          <% if (pagination.hasNext) { %>
            <li class="page-item">
                <a class="page-link" 
                   href="/threads?page=<%= pagination.currentPage + 1 %>"
                   aria-label="Go to next page">
                   Next
                </a>
            </li>
          <% } %>
        </ul>
      </nav>
    </section>

    <!-- Sidebar -->
    <aside class="col-12 col-md-3" aria-labelledby="sidebar-heading">
      <div class="sidebar">
        <h2 id="sidebar-heading" class="visually-hidden">Forum Actions and Popular Tags</h2>
        
        <!-- Create Post Button -->
        <div class="create-button">
          <a href="/threads/new">
            <button aria-describedby="create-help">CREATE THREAD!</button>
          </a>
          <span id="create-help" class="visually-hidden">Start a new discussion thread</span>
        </div>
        
        <!-- Manage post button -->
        <div class="manage-thread">
          <a href="/threads/my-posts">
            <button aria-describedby="manage-help">Manage My Threads</button>
          </a>
          <span id="manage-help" class="visually-hidden">View and edit your posted threads</span>
        </div>

        <!-- Popular Tags -->
        <section class="tags" aria-labelledby="popular-tags-heading">
          <h3 id="popular-tags-heading">Popular Tags</h3>
          <ul role="list" aria-label="Popular thread tags">
            <% tags.forEach(tag => { %>
              <li>
                <a href="/threads/search?tags=<%= tag.tag %>" 
                   aria-label="View threads tagged with <%= tag.tag %>, <%= tag.count %> threads">
                   <%= tag.tag %> (<%= tag.count %>)
                </a>
              </li>
            <% }) %>
          </ul>
        </section>
      </div>
    </aside>

  </div>
</main>

<!--Bootstrap-->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
</body>
<footer>
  <!-- Footer -->
   <div>
    <%- include('../partials/footer') %>
  </div>
</footer>
</html>