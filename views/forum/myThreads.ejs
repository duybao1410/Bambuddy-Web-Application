<!DOCTYPE html>
<html>
<head>
  <title>My Threads</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CSS and bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/forum.css">
    <link rel="stylesheet" href="/css/style.css">
  <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>
    <script src="/js/theme-loader.js"></script>
  </head>
  <body class="<%= (typeof user !== 'undefined' && user && user.theme) ? user.theme : '' %>">
  <div>
    <%- include('../partials/navbar') %>
  </div>
  <div class="container">
      <div class="row">
        <div class="my-posts-header-image">
          <h1>My Threads</h1>
        </div>
      </div>
  </div>

  <br>
  <div class="container user-info">
    <div class="card user-info" style="max-width: auto;">
      <div class="card-body d-flex  p-3">
        <img src="<%= (user && user.profilePicture)
              ? (user.profilePicture.startsWith('http')
                  ? user.profilePicture
                  : ('/uploads/profilePicture/' + user.profilePicture))
              : '/img/defaultAvatar.png' %>"
              alt="User Avatar" class="rounded-circle me-3" style="width: 150px; height: 150px; object-fit: cover;"> 
        <div>
          <div>
            <h1 class="card-title mb-1"><%= user.profileInfo?.firstName || 'Guest' %> <%= user.profileInfo?.lastName || '' %></h1>
            <small class="text-muted"><%= user.email %></small>
          </div>
        </div>
      </div>
    </div>
  </div>

<div class="container my-thread-container" style="margin-top: 2rem; margin-bottom: 2rem;">
  <div>
    <% if (threads && threads.length > 0) { %>
      <% threads.forEach((thread, idx) => { %>
        <div>
          <div class="d-flex justify-content-between align-items-start">
            <h3>
              <a href="/threads/<%= thread._id %>" style="color: var(--primary-dark);"><%= thread.title %></a>
              <% if (thread.status === 'pending') { %>
                <small>(Pending)</small>
              <% } else if (thread.status === 'rejected') { %>
                <small class="text-danger">(Rejected)</small>
              <% } else if (thread.status === 'hidden') { %>
                <small>(Hidden)</small>
              <% } else if (thread.status === 'deleted') { %>
                <span>(Deleted)</span>
              <% } else { %>
                <span>(Active)</span>
              <% } %>
            </h3>
            
            <!-- Action buttons dropdown -->
            <div class="dropdown">
              <button class="btn btn-link text-muted p-1" type="button" id="dropdownMenuButton<%= thread._id %>" data-bs-toggle="dropdown" aria-expanded="false" style="border: none; background: none;">
                <svg width="16" height="16" fill="currentColor" class="bi bi-three-dots" viewBox="0 0 16 16">
                  <path d="M3 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm5 0a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
                </svg>
              </button>
              <ul class="dropdown-menu" aria-labelledby="dropdownMenuButton<%= thread._id %>">
                <% if (thread.status === 'active') { %>
                  <li><a class="dropdown-item" href="/threads/<%= thread._id %>/edit">Update</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/threads/<%= thread._id %>/hide?_method=PATCH" method="POST" class="m-0">
                      <button type="submit" class="dropdown-item">Hide</button>
                    </form>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/threads/<%= thread._id %>?_method=DELETE" method="POST" class="m-0">
                      <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this thread?');">Delete</button>
                    </form>
                  </li>
                <% } else if (thread.status === 'hidden') { %>
                  <li><a class="dropdown-item" href="/threads/<%= thread._id %>/edit">Update</a></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/threads/<%= thread._id %>/unhide?_method=PATCH" method="POST" class="m-0">
                      <button type="submit" class="dropdown-item">Unhide</button>
                    </form>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/threads/<%= thread._id %>?_method=DELETE" method="POST" class="m-0">
                      <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this thread?');">Delete</button>
                    </form>
                  </li>
                <% } else if (thread.status === 'pending') { %>
                  <li><span class="dropdown-item text-muted">Locked while pending</span></li>
                <% } else if (thread.status === 'rejected') { %>
                  <li><button type="button" class="dropdown-item" data-bs-toggle="modal" data-bs-target="#reasonModal-<%= thread._id %>">See Reason</button></li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <form action="/threads/<%= thread._id %>?_method=DELETE" method="POST" class="m-0">
                      <button type="submit" class="dropdown-item text-danger" onclick="return confirm('Are you sure you want to delete this thread?');">Delete</button>
                    </form>
                  </li>
                <% } %>
              </ul>
            </div>
          </div>
          <p><%= thread.content.substring(0, 150) %>...</p>
          <small>Last updated: <%= new Date(thread.updatedAt).toLocaleString() %></small>
          <% if (idx < threads.length - 1) { %>
            <hr>
          <% } %>
        </div>

        <% if (thread.status === 'rejected') { %>
          <div class="modal fade" id="reasonModal-<%= thread._id %>" tabindex="-1" aria-labelledby="reasonModalLabel-<%= thread._id %>" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
              <div class="modal-content" style="background-color: var(--card-bg); color: var(--text-color);">
                <div class="modal-header" style="border-bottom: 1px solid var(--border-color);">
                  <h5 class="modal-title" id="reasonModalLabel-<%= thread._id %>">Rejection Reason</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="filter: invert(1);"></button>
                </div>
                <div class="modal-body">
                  <div class="alert alert-danger" role="alert">
                    <p class="mb-0"><%= thread.rejectionReason || 'No reason provided.' %></p>
                  </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid var(--border-color);">
                  <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      <% }) %>
    <% } else { %>
      <div>
        <p>You have not created any threads yet.</p>
      </div>
    <% } %>
  </div>
</div>
<% if (pagination && threads && threads.length > 0) { %>
  <% 
    const currentPage = Number(pagination.currentPage || 1);
    const totalPages  = Number(pagination.totalPages || 1);
    const canPrev     = currentPage > 1;
    const canNext     = currentPage < totalPages;
    const limit       = 10; // keep in sync with backend
    const maxPagesToShow = 5;

    const startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
    const endPage   = Math.min(totalPages, startPage + maxPagesToShow - 1);
  %>

  <% if (totalPages > 1) { %>
    <nav class="mt-3">
      <ul class="pagination mx-auto justify-content-center">

        <!-- Prev (only if available) -->
        <% if (canPrev) { %>
          <li class="page-item">
            <a class="page-link" href="/threads/my-posts?page=<%= currentPage - 1 %>&limit=<%= limit %>" aria-label="Previous"> Previous
            </a>
          </li>
        <% } %>

        <!-- First page + leading ellipsis -->
        <% if (startPage > 1) { %>
          <li class="page-item">
            <a class="page-link" href="/threads/my-posts?page=1&limit=<%= limit %>">1</a>
          </li>
          <% if (startPage > 2) { %>
            <li class="page-item disabled"><span class="page-link">…</span></li>
          <% } %>
        <% } %>

        <!-- trailing ellipsis + last page -->
        <% if (endPage < totalPages) { %>
          <% if (endPage < totalPages - 1) { %>
            <li class="page-item disabled"><span class="page-link">…</span></li>
          <% } %>
          <li class="page-item">
            <a class="page-link" href="/threads/my-posts?page=<%= totalPages %>&limit=<%= limit %>"><%= totalPages %></a>
          </li>
        <% } %>
        <li class="page-item disabled">         
            <span class="page-link">Page <%= pagination.currentPage %> of <%= pagination.totalPages %></span>
            </li>

        <!-- Next (only if available) -->
        <% if (canNext) { %>
          <li class="page-item">
            <a class="page-link" href="/threads/my-posts?page=<%= currentPage + 1 %>&limit=<%= limit %>" aria-label="Next">
              Next
            </a>
          </li>
        <% } %>
      </ul>
    </nav>
  <% } %>
<% } %>

  <!-- Bootstrap JS -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.3/js/bootstrap.bundle.min.js" integrity="sha512-7Pi/otdlbbCR+LnW+F7PwFcSDJOuUJB3OxtEHbg4vSMvzvJjde4Po1v4BR9Gdc9aXNUNFVUY+SK51wWT8WF0Gg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
</body>
<footer>
  <!-- Footer -->
   <div>
    <%- include('../partials/footer') %>
  </div>
</footer>
</html>