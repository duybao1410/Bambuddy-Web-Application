<!DOCTYPE html>
<html>
<head>
  <title>Search Results</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- CSS and bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr" crossorigin="anonymous">
    <link rel="stylesheet" href="/css/forum.css">
    <link rel="stylesheet" href="/css/style.css">
  <!-- Google Font -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>
    <script src="/js/theme-loader.js"></script>
  </head>
  <body class="<%= user?.theme || 'light' %>">
  <div>
    <%- include('../partials/navbar') %>
  </div>
  <div class="container mt-4">
    <div class="row">
      <!-- Centered header -->
      <h1 class="text-center mb-4">
        Search Results 
        <% if (query) { %>for "<strong><%= query %></strong>" <% } %>
        <% if (tags) { %>with tags: <strong><%= tags %></strong> <% } %>
      </h1>

      <div class="mb-3">
        <a href="/threads" style="text-decoration: none; color:var(--primary-dark)">‚Üê Return to main page</a>
      </div>

    <!-- Search Form (right aligned col-12 col-md-4) -->
    
      <!-- Error or Results -->
      <% if (typeof error !== 'undefined' && error) { %>
        <p class="text-danger"><%= error %></p>
      <% } else if (data && data.threads && data.threads.length > 0) { %>
    
      <!-- Results list -->
      <div class="col-12 col-md-8" style="min-height: 630px;">
        <div class="list-group">
          <% data.threads.forEach(thread => { %>
            <div class="list-group-item">
              <h4>
                <a href="/threads/<%= thread._id %>" style="text-decoration: none; color:var(--primary-dark)"><%= thread.title %></a>
              </h4>
              <p class="mb-1">
                By <a href="/member/<%= thread.authorId?._id %>" style="text-decoration: none;">
                  <%= thread.authorId?.profileInfo?.firstName %> <%= thread.authorId?.profileInfo?.lastName || 'Unknown Author' %>
                </a> |
                Last activity: <%= new Date(thread.lastActivity).toLocaleString() %>
              </p>
              <p class="mb-1">
                Likes <%= thread.likeCount %> | Unlikes <%= thread.dislikeCount %> | Comments <%= thread.commentCount %>
              </p>
              <% if (thread.tags && thread.tags.length > 0) { %>
                <p class="mb-0">
                  Tags: 
                  <% thread.tags.forEach(tag => { %>
                    <a href="/threads/search?tags=<%= tag %>" class="badge badge-custom text-decoration-none">#<%= tag %></a>
                  <% }) %>
                </p>
              <% } %>
            </div>
          <% }) %>
        </div>
    

      <!-- Pagination -->
      <nav class="mt-3">
        <ul class="pagination mx-auto justify-content-center">
          <% if (data.pagination.currentPage > 1) { %>
            <li class="page-item">
              <a class="page-link" href="/threads/search?q=<%= query || '' %>&page=<%= data.pagination.currentPage - 1 %>&category=<%= category || '' %>&tags=<%= tags || '' %>&author=<%= author || '' %>&sort=<%= sort || 'relevance' %>">Previous</a>
            </li>
          <% } %>

          <li class="page-item disabled">
            <span class="page-link">Page <%= data.pagination.currentPage %> of <%= data.pagination.totalPages %></span>
          </li>

          <% if (data.pagination.currentPage < data.pagination.totalPages) { %>
            <li class="page-item">
              <a class="page-link" href="/threads/search?q=<%= query || '' %>&page=<%= data.pagination.currentPage + 1 %>&category=<%= category || '' %>&tags=<%= tags || '' %>&author=<%= author || '' %>&sort=<%= sort || 'relevance' %>">Next</a>
            </li>
          <% } %>
        </ul>
      </nav>
      </div>
          <div class="col-12 col-md-3 ms-auto">
            <form action="/threads/search" method="GET">
              <div class="mb-2">
                <input type="text" name="q" value="<%= query || '' %>" placeholder="Search threads..." minlength="2" class="form-control">
              </div>

              <div class="mb-2">
                <input type="text" name="tags" value="<%= tags || '' %>" placeholder="Tags (comma-separated)" class="form-control">
              </div>

              <div class="d-flex flex-wrap gap-2">
                <select name="sort" class="form-select flex-grow-1">
                  <option value="relevance" <%= sort === 'relevance' ? 'selected' : '' %>>Relevance</option>
                  <option value="lastActivity" <%= sort === 'lastActivity' ? 'selected' : '' %>>Last Activity</option>
                  <option value="createdAt" <%= sort === 'createdAt' ? 'selected' : '' %>>Created Date</option>
                </select>
                <button type="submit" class="btn btn-primary">Search</button>
              </div>
            </form>
          </div>
        </div>
      
  </div>
  
    <% } else { %>
      <p>No threads found for your search.</p>
    <% } %>]
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>

</body>
</body>
<footer>
  <!-- Footer -->
   <div>
    <%- include('../partials/footer') %>
  </div>
</footer>
</html>
