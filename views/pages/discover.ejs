<!-- Tour Discovery Page -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tour Discovery</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/tour.css">
    <link rel="stylesheet" href="/css/style.css">
    <link rel="stylesheet" href="/css/theme.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js" integrity="sha384-ndDqU0Gzau9qJ1lfW4pNLlhNTkCfHzAVBReH9diLvGRem5+R9g2FzA8ZGN954O5Q" crossorigin="anonymous"></script>
    <script src="/js/theme-loader.js"></script>
  </head>

  <body class="<%= user?.theme || 'light' %>" data-logged-in="<%= !!user %>" data-user-role="<%= user?.role || '' %>">

  <header role="banner">
    <%- include('../partials/navbar') %>
  </header>


  <!-- Search Header -->
  <div class="container">
    <div class="header-bg discover-page my-md-3" role="region" aria-labelledby="tourHeader">
      <h1 id="tourHeader">Tour</h1>
      <div class="container" role="search">
        <form action="/discover" method="GET" class="mt-3 col-md-6 mx-auto" aria-label="Search Tours">
          <div class="input-group">
            <input type="search" name="search" class="form-control" value="<%= query.search || '' %>" placeholder="Place to go, things to do..." aria-label="Search input" aria-autocomplete="list" aria-controls="autocomplete-results">
            <ul id="autocomplete-results" class="list-group position-absolute w-100 z-10" style="top: 100%;" role="listbox" aria-label="Search suggestions"></ul>
            <button type="submit" class="btn btn-primary" aria-label="Search">Search</button>
          </div>
        </form>
      </div>
    </div>
  </div>


  <!-- Filter + Tour List -->
  <main class="container" role="main">
    <div class="row">
      <!-- Filter Sidebar -->
      <aside class="col-md-3" role="region" aria-labelledby="filterHeading">
        <form action="/discover" method="GET" role="form" aria-label="Filter Tours">
          <h2 id="filterHeading" class="h5 mt-2">Filters</h2>
          <!-- Price Range -->
          <div class="form-group" aria-label="Price Range">
            <input type="number" name="minPrice" value="<%= query.minPrice || '' %>" placeholder="Min Price" class="form-control mb-2" aria-label="Minimum Price">
            <input type="number" name="maxPrice" value="<%= query.maxPrice || '' %>" placeholder="Max Price" class="form-control mb-2" aria-label="Maximum Price">
          </div>


          <!-- Categories -->
          <fieldset class="form-group border border-1 border-dark mt-3 p-3 rounded" aria-label="Categories">
            <legend class="visually-hidden">Tour Categories</legend>
            <% const categories = [
              "Food and Culinary Tours", "Historical Tours", "Cultural Experiences",
              "Shopping Tours", "Photography Tours", "Night Life", "Chilling and Relaxing Tours"
            ]; %>
            <% for (let i = 0; i < categories.length; i++) { %>
              <label>
                <input class="form-check-input" type="checkbox" name="category" value="<%= categories[i] %>"
                  <%= query.category && query.category.includes(categories[i]) ? 'checked' : '' %>
                  aria-checked="<%= query.category && query.category.includes(categories[i]) ? 'true' : 'false' %>">
                <%= categories[i] %>
              </label><br>
            <% } %>
          </fieldset>


          <!-- Hidden fields -->
          <input type="hidden" name="search" value="<%= query.search || '' %>">
          <input type="hidden" name="sortBy" value="<%= query.sortBy || '' %>">
          <input type="hidden" name="sortOrder" value="<%= query.sortOrder || '' %>">
          <button type="submit" class="btn btn-primary mt-2" aria-label="Apply Filters">Apply Filters</button>
        </form>
      </aside>


      <!-- Tour Content + Sorting -->
      <section class="col-md-9" aria-labelledby="resultsHeading">
        <!-- Sorting -->
        <div class="mb-3" role="region" aria-label="Sort Tours">
          <h4 id="resultsHeading">Sort tour activities by:</h4>
          <form action="/discover" method="GET" id="sortForm" aria-label="Sort Options">
            <select name="sortBy" class="form-select" id="sortSelect" aria-label="Sort By">
              <option disabled selected>-- Select sorting --</option>
              <option value="bookingCount" <%= query.sortBy === 'bookingCount' ? 'selected' : '' %>>Most Popular</option>
              <option value="pricing|desc" <%= query.sortBy === 'pricing' && query.sortOrder === 'desc' ? 'selected' : '' %>>Most Expensive</option>
              <option value="pricing|asc" <%= query.sortBy === 'pricing' && query.sortOrder === 'asc' ? 'selected' : '' %>>Cheapest</option>
              <option value="createdAt|desc" <%= query.sortBy === 'createdAt' && query.sortOrder === 'desc' ? 'selected' : '' %>>Newest</option>
              <option value="createdAt|asc" <%= query.sortBy === 'createdAt' && query.sortOrder === 'asc' ? 'selected' : '' %>>Oldest</option>
            </select>
            <input type="hidden" name="sortOrder" id="sortOrderInput" value="<%= query.sortOrder || '' %>">
            <input type="hidden" name="search" value="<%= query.search || '' %>">
            <input type="hidden" name="minPrice" value="<%= query.minPrice || '' %>">
            <input type="hidden" name="maxPrice" value="<%= query.maxPrice || '' %>">
            <% if (query.category) {
              const selectedCategories = Array.isArray(query.category) ? query.category : [query.category];
              selectedCategories.forEach(cat => { %>
                <input type="hidden" name="category[]" value="<%= cat %>">
            <% }) } %>
          </form>
        </div>


        <!-- Tour Grid -->
        <div class="row" role="region" aria-label="Tour List">
          <% if (data.tours && data.tours.length > 0) { %>
            <% data.tours.forEach(tour => { %>
              <div class="col-md-4 mb-4">
                <div class="card h-100 shadow-sm" role="article" aria-labelledby="tour-<%= tour._id %>">
                  <img src="/uploads/tours/<%= tour.images[0] %>" class="card-img-top" alt="<%= tour.title %> image">
                  <div class="card-body position-relative">
                    <a href="/tourDetail/<%= tour._id %>" class="text-decoration-none text-dark">
                      <h5 class="card-title fs-6" id="tour-<%= tour._id %>" style="height: 2.4em; overflow: hidden; line-height: 1.2em; -webkit-box-orient: vertical;"><%= tour.title %></h5>
                    </a>
                    <p class="text-muted"><i class="bi bi-geo-alt-fill"></i> <%= tour.location.city %></p>
                    <p class="card-text mb-0"><%= tour.description.slice(0, 80) %>...</p>
                    <!-- Save Button and Compare Button (right side) -->
                    <div class="d-flex gap-2">
                      <button type="button" 
                              class="btn btn-sm p-0 border-0 bg-transparent text-primary save-tour-btn<% if (user && (user.role === 'admin' || user.role === 'tourguide')) { %> disabled text-muted<% } %>" 
                              data-tour-id="<%= tour._id %>" 
                              <% if (user && (user.role === 'admin' || user.role === 'tourguide')) { %>disabled title="This role cannot save tours"<% } %>
                              aria-label="Save <%= tour.title %> tour">
                          <i class="bi bi-bookmark save-icon"></i>
                      </button>
                      <button type="button" 
                              class="btn btn-sm p-0 border-0 bg-transparent text-success compare-tour-btn" 
                              data-tour-id="<%= tour._id %>"
                              data-tour-title="<%= tour.title %>"
                              data-tour-image="<%= tour.images[0] %>"
                              aria-label="Add <%= tour.title %> to comparison">
                          <i class="bi bi-plus-circle"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-footer">
                    <% const rating = tour.averageRating || 0; %>
                    <% const fullStars = Math.floor(rating); %>
                    <% const halfStar = (rating % 1 >= 0.25 && rating % 1 < 0.75); %>
                    <% const emptyStars = 5 - fullStars - (halfStar ? 1 : 0); %>
                    <div class="d-flex align-items-center text-warning" aria-label="Rating: <%= rating.toFixed(1) %> out of 5">
                      <% for (let i = 0; i < fullStars; i++) { %>
                        <i class="bi bi-star-fill" aria-hidden="true"></i>
                      <% } %>
                      <% if (halfStar) { %>
                        <i class="bi bi-star-half" aria-hidden="true"></i>
                      <% } %>
                      <% for (let i = 0; i < emptyStars; i++) { %>
                        <i class="bi bi-star" aria-hidden="true"></i>
                      <% } %>
                      <small class="text-muted ms-2">(<%= rating.toFixed(1) %> / <%= tour.rating.length %> reviews)</small>
                    </div>
                    <div class="fw-bold text-end text-success" aria-label="Price: <%= tour.pricing.toLocaleString('vi-VN') %> VND">
                      <%= tour.pricing.toLocaleString('vi-VN') %> VND
                    </div>
                  </div>
                </div>
              </div>
            <% }) %>
          <% } else { %>
            <div class="col-12">
              <p>No tours found.</p>
            </div>
          <% } %>
        </div>
      </section>
    </div>
    
    <!-- Tour Comparison Box - Floating/Sticky -->
    <div id="comparisonBox" class="comparison-floating-box" style="display: none;">
      <div class="card shadow-lg border-0">
        <!-- Full View -->
        <div class="card-body p-3" id="comparisonContent">
          <div class="row g-2">
            <!-- Tour Slot 1 -->
            <div class="col-md-4 col-12">
              <div class="tour-slot" id="tourSlot1">
                <div class="placeholder-card">
                  <div class="placeholder-icon">
                    <i class="bi bi-plus-circle text-muted"></i>
                  </div>
                  <small class="text-muted">Select a tour to compare</small>
                </div>
              </div>
            </div>
            
            <!-- Tour Slot 2 -->
            <div class="col-md-4 col-12">
              <div class="tour-slot" id="tourSlot2">
                <div class="placeholder-card">
                  <div class="placeholder-icon">
                    <i class="bi bi-plus-circle text-muted"></i>
                  </div>
                  <small class="text-muted">Select a tour to compare</small>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons Column -->
            <div class="col-md-4 col-12 d-flex flex-column justify-content-center">
              <h6 class="mb-2 fw-bold text-center" id="statusText">Selected 0 tour</h6>
              <button type="button" class="btn btn-sm mb-2" id="compareButton" disabled>
                Compare
              </button>
              <button type="button" class="btn btn-sm" id="minimizeButton">
                Minimize
              </button>
            </div>
          </div>
        </div>
        
        <!-- Minimized View -->
        <div class="card-body text-center" id="minimizedContent" style="display: none;">
          <small class="fw-bold">Comparison</small>
        </div>
      </div>
    </div>
  </main>


  <!-- Pagination Section -->
  <nav aria-label="Page navigation">
    <ul class="pagination justify-content-center text-center" role="navigation">
      <% const currentPage = data.pagination.page || 1; %>
      <% const totalPages = data.pagination.totalPages || 1; %>


      <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
        <a class="page-link" href="?<%= buildQuery({ ...query, page: currentPage - 1 }) %>" aria-label="Previous page" aria-disabled="<%= currentPage === 1 %>">Previous</a>
      </li>


      <% for (let i = 1; i <= totalPages; i++) { %>
        <li class="page-item <%= i === currentPage ? 'active' : '' %>">
          <a class="page-link" href="?<%= buildQuery({ ...query, page: i }) %>" aria-label="Go to page <%= i %>" aria-current="<%= i === currentPage ? 'page' : false %>"><%= i %></a>
        </li>
      <% } %>


      <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
        <a class="page-link" href="?<%= buildQuery({ ...query, page: currentPage + 1 }) %>" aria-label="Next page" aria-disabled="<%= currentPage === totalPages %>">Next</a>
      </li>
    </ul>
  </nav>


  <footer role="contentinfo">
    <%- include('../partials/footer') %>
  </footer>


  <!-- Scripts -->
  <script src="/js/discover.js"></script>
  </body>
</html>





