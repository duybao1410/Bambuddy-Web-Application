<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Forgot Password</title>
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700&display=swap"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Custom CSS -->
  <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/theme.css" />
  <link rel="stylesheet" href="/css/auth.css" />
  <!-- Axios -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <!-- Password Validation -->
  <script src="/js/passwordValidation.js"></script>
    
  </head>
  <body class="light">
<div class="container-fluid">
  <div class="row min-vh-100">
    <!-- Left Panel -->
    <div class="col-md-6 d-flex justify-content-center align-items-center">
      <div class="auth-left-inner text-center">
        <h2 class="brand-title brand-title-light">Bambuddy</h2>
        <p class="brand-subtitle">The road to <br> authentic tourism <br> experiences</p>
        <img src="/img/AccountPage.png" alt="Tourism" class="rounded shadow">
      </div>
    </div>
    <!-- Right Panel -->
    <div class="col-md-6 d-flex justify-content-center align-items-center bg-white">
      <div class="auth-card w-100">
        <h3 class="auth-title">Reset Password</h3>
        <form id="resetForm">
          <!-- Email -->
          <div class="mb-3">
            <label class="form-label">Email</label>
            <input type="email" id="email" class="form-control" placeholder="you@example.com" required>
          </div>
          <!-- Recovery Token -->
          <div class="mb-3">
            <label class="form-label">Recovery Token</label>
            <input type="text" id="token" class="form-control" placeholder="Your Recovery Token" required>
          </div>
          <!-- New Password -->
          <div class="mb-3">
            <label class="form-label">New Password</label>
            <div class="position-relative">
              <input type="password" id="newPassword" class="form-control" placeholder="********" required>
              <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y pe-3 text-muted password-toggle-btn" onclick="togglePassword('newPassword', 'newPasswordToggle')" id="newPasswordToggle">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
          <!-- Confirm Password -->
          <div class="mb-3">
            <label class="form-label">Confirm Password</label>
            <div class="position-relative">
              <input type="password" id="confirmPassword" class="form-control" placeholder="********" required>
              <button type="button" class="btn btn-link position-absolute end-0 top-50 translate-middle-y pe-3 text-muted password-toggle-btn" onclick="togglePassword('confirmPassword', 'confirmPasswordToggle')" id="confirmPasswordToggle">
                <i class="bi bi-eye"></i>
              </button>
            </div>
          </div>
          <button type="submit" class="btn auth-btn w-100">Reset Password</button>
        </form>
        <p class="auth-footer">
          Back to <a href="/auth/login" class="signin-link">Sign In</a>
        </p>
      </div>
    </div>
  </div>
</div>

<script>
// Notification system
function showNotification(message, type = 'info') {
  // Remove existing notifications
  const existingNotifications = document.querySelectorAll('.notification');
  existingNotifications.forEach(notification => notification.remove());

  // Create new notification
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);

  // Show notification
  setTimeout(() => {
    notification.classList.add('show');
  }, 100);

  // Hide notification after 5 seconds
  setTimeout(() => {
    notification.classList.remove('show');
    setTimeout(() => {
      notification.remove();
    }, 300);
  }, 5000);
}

// Smooth password toggle
function togglePassword(inputId, buttonId) {
  const input = document.getElementById(inputId);
  const button = document.getElementById(buttonId);
  const icon = button.querySelector('i');
  
  if (input.type === 'password') {
    input.type = 'text';
    icon.className = 'bi bi-eye-slash';
    button.classList.remove('text-muted');
    button.classList.add('text-primary');
  } else {
    input.type = 'password';
    icon.className = 'bi bi-eye';
    button.classList.remove('text-primary');
    button.classList.add('text-muted');
  }
}

// Setup password field event listeners
function setupPasswordFields() {
  const passwordFields = ['newPassword', 'confirmPassword'];
  
  passwordFields.forEach(fieldId => {
    const input = document.getElementById(fieldId);
    const button = document.getElementById(fieldId + 'Toggle');
    
    if (input && button) {
      // Remove any existing event listeners first
      input.removeEventListener('focus', showEyeIcon);
      input.removeEventListener('input', handleInput);
      input.removeEventListener('blur', hideEyeIcon);
      
      // Show eye icon on focus or when typing
      input.addEventListener('focus', showEyeIcon);
      input.addEventListener('input', handleInput);
      input.addEventListener('blur', hideEyeIcon);
      
      function showEyeIcon() {
        button.style.display = 'block';
      }
      
      function handleInput() {
        if (input.value.length > 0) {
          button.style.display = 'block';
        } else {
          button.style.display = 'none';
        }
      }
      
      function hideEyeIcon() {
        if (input.value.length === 0) {
          button.style.display = 'none';
        }
      }
    }
  });
}

// Initialize password fields when page loads
document.addEventListener('DOMContentLoaded', setupPasswordFields);

document.querySelector("#resetForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const email = document.querySelector("#email").value.trim();
  const token = document.querySelector("#token").value.trim();
  const newPassword = document.querySelector("#newPassword").value;
  const confirmPassword = document.querySelector("#confirmPassword").value;

  if (!email) {
    showNotification("Email is required!", "error");
    return;
  }

  if (!token) {
    showNotification("Recovery token is required!", "error");
    return;
  }

  // Clear previous errors
  clearPasswordErrors();
  
  // Validate password strength
  const passwordValidation = validatePassword(newPassword);
  if (!passwordValidation.isValid) {
    showPasswordErrors(passwordValidation.errors);
    return;
  }

  if (newPassword !== confirmPassword) {
    showNotification("Passwords do not match!", "error");
    return;
  }

  try {
    
    const res = await axios.post(`/auth/reset-password/${token}`, {
      email: email,
      newPassword: newPassword
    });

    

    if (res.data.success) {
      showNotification("Password reset successfully! Please sign in.", "success");
      setTimeout(() => {
        window.location.href = "/auth/login";
      }, 1500);
    } else {
      showNotification(res.data.message || "Reset failed", "error");
    }
  } catch (err) {
    console.error("Error from backend:", err.response || err);
    showNotification(err.response?.data?.message || "Network error. Please try again.", "error");
  }
});
</script>
</body>
</html>
